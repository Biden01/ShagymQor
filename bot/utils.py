from django.db.models import Q
from bot.models import Department
from asgiref.sync import sync_to_async
import re
import logging
from typing import Tuple, Optional

logger = logging.getLogger(__name__)

@sync_to_async
def get_department(name: str) -> Optional[Department]:
    try:
        return Department.objects.get(name=name)
    except Department.DoesNotExist:
        return None

async def analyze_complaint_text(text: str) -> Tuple[Optional[Department], float]:
    """
    Анализирует текст обращения и определяет наиболее подходящее управление
    """
    logger.info(f"Начинаем анализ текста: {text}")
    
    # Словарь ключевых слов для каждого управления
    keywords = {
        'Управление образования': [
            'школа', 'школу', 'школы', 'школьный', 'школьная', 'школьное',
            'учитель', 'учителя', 'учителей', 'ученик', 'ученики', 'учеников',
            'образование', 'обучение', 'учеба', 'учебный', 'учебная', 'учебное',
            'детский сад', 'детский садик', 'детсада', 'детсад',
            'дошкольное', 'дошкольный', 'дошкольная',
            'экзамен', 'егэ', 'унт', 'аттестат', 'диплом',
            'репетитор', 'курсы', 'подготовка',
            'столовая', 'питание', 'школьное питание',
            'спортзал', 'спортивный зал', 'стадион',
            'библиотека', 'книги', 'учебники',
            'инклюзивное образование', 'инвалид', 'особые потребности'
        ],
        'Управление здравоохранения': [
            'больница', 'поликлиника', 'врач', 'доктор', 'медицинский',
            'здоровье', 'болезнь', 'лечение', 'аптека', 'медикаменты',
            'прививка', 'вакцина', 'эпидемия', 'карантин',
            'скорую', 'скорая помощь', 'неотложка',
            'стоматолог', 'зубы', 'стоматология',
            'педиатр', 'детский врач', 'детская поликлиника',
            'терапевт', 'терапевтический',
            'хирург', 'хирургия', 'операция',
            'анализ', 'лаборатория', 'диагностика',
            'реабилитация', 'санаторий', 'профилактика',
            'медицинская страховка', 'страховка', 'медстраховка'
        ],
        'Управление жилищно-коммунального хозяйства': [
            'жкх', 'коммунальные', 'квартплата', 'жилищный',
            'отопление', 'тепло', 'батарея', 'радиатор',
            'вода', 'горячая вода', 'холодная вода',
            'канализация', 'сток', 'труба', 'трубы',
            'мусор', 'мусорка', 'контейнер', 'вывоз мусора',
            'уборка', 'двор', 'подъезд', 'лифт',
            'ремонт', 'протечка', 'затопление',
            'электричество', 'свет', 'электроэнергия',
            'газ', 'газовая служба', 'газовая плита',
            'домофон', 'домофонная связь',
            'парковка', 'стоянка', 'автомобиль'
        ],
        'Управление транспорта': [
            'автобус', 'троллейбус', 'трамвай', 'маршрутка',
            'остановка', 'расписание', 'график движения',
            'такси', 'транспорт', 'проезд', 'проездной',
            'дорога', 'улица', 'перекресток', 'светофор',
            'парковка', 'стоянка', 'автомобиль',
            'дтп', 'авария', 'дорожное происшествие',
            'знак', 'разметка', 'пешеходный переход',
            'пробка', 'затор', 'дорожное движение',
            'водитель', 'пассажир', 'пешеход'
        ],
        'Управление культуры': [
            'музей', 'театр', 'кинотеатр', 'библиотека',
            'концерт', 'выставка', 'фестиваль',
            'культура', 'искусство', 'творчество',
            'клуб', 'дворец культуры', 'дом культуры',
            'хор', 'оркестр', 'ансамбль',
            'танцы', 'музыка', 'пение',
            'праздник', 'мероприятие', 'акция',
            'памятник', 'история', 'наследие',
            'традиции', 'обычаи', 'фольклор'
        ],
        'Управление спорта': [
            'спорт', 'спортивный', 'стадион', 'спортзал',
            'бассейн', 'тренажерный зал', 'фитнес',
            'соревнование', 'турнир', 'чемпионат',
            'тренер', 'спортсмен', 'команда',
            'футбол', 'хоккей', 'баскетбол',
            'плавание', 'бег', 'велосипед',
            'лыжи', 'коньки', 'теннис',
            'бокс', 'борьба', 'дзюдо',
            'йога', 'пилатес', 'аэробика'
        ],
        'Управление социальной защиты': [
            'пенсия', 'пособие', 'выплата', 'социальная помощь',
            'инвалид', 'инвалидность', 'льгота',
            'малоимущий', 'малообеспеченный', 'нуждающийся',
            'сирота', 'детский дом', 'опека',
            'пожилой', 'ветеран', 'инвалид войны',
            'беженец', 'переселенец', 'мигрант',
            'безработный', 'трудоустройство', 'занятость',
            'социальный работник', 'социальная служба',
            'благотворительность', 'волонтерство'
        ],
        'Управление экономики': [
            'бизнес', 'предприятие', 'компания', 'фирма',
            'налог', 'сбор', 'пошлина', 'бюджет',
            'инвестиция', 'развитие', 'экономика',
            'работа', 'зарплата', 'трудоустройство',
            'рынок', 'торговля', 'магазин',
            'банк', 'кредит', 'ипотека',
            'страхование', 'пенсионный фонд',
            'тариф', 'цена', 'стоимость',
            'инфляция', 'курс', 'валютный'
        ],
        'Управление архитектуры': [
            'строительство', 'стройка', 'здание', 'дом',
            'архитектура', 'проект', 'планировка',
            'ремонт', 'реконструкция', 'реставрация',
            'земля', 'участок', 'территория',
            'разрешение', 'согласование', 'документы',
            'инфраструктура', 'благоустройство', 'озеленение',
            'парк', 'сквер', 'площадь',
            'дорога', 'тротуар', 'мостовая',
            'освещение', 'фонарь', 'электричество'
        ],
        'Управление экологии': [
            'экология', 'природа', 'окружающая среда',
            'мусор', 'отходы', 'утилизация',
            'воздух', 'загрязнение', 'выбросы',
            'вода', 'река', 'озеро', 'пруд',
            'зелень', 'дерево', 'кустарник',
            'животное', 'птица', 'рыба',
            'заповедник', 'парк', 'сквер',
            'климат', 'погода', 'осадки',
            'радиация', 'химия', 'опасность'
        ],
        'Управление внутренней политики': [
            'выборы', 'голосование', 'избирательный участок',
            'общество', 'общественный', 'общественная организация',
            'религия', 'церковь', 'мечеть',
            'национальность', 'этнос', 'традиции',
            'сми', 'средства массовой информации', 'журналист',
            'протест', 'митинг', 'демонстрация',
            'безопасность', 'порядок', 'закон',
            'права', 'свободы', 'обязанности',
            'гражданство', 'паспорт', 'регистрация'
        ],
        'Управление по делам молодежи': [
            'молодежь', 'молодой', 'подросток',
            'студент', 'университет', 'колледж',
            'волонтер', 'доброволец', 'активист',
            'клуб', 'центр', 'организация',
            'мероприятие', 'акция', 'проект',
            'спорт', 'творчество', 'искусство',
            'трудоустройство', 'работа', 'карьера',
            'образование', 'обучение', 'развитие',
            'досуг', 'отдых', 'развлечение'
        ],
        'Управление по развитию языков': [
            'язык', 'казахский', 'русский', 'английский',
            'обучение', 'курсы', 'школа',
            'перевод', 'переводчик', 'интерпретация',
            'литература', 'книга', 'писатель',
            'культура', 'традиции', 'обычаи',
            'национальность', 'этнос', 'народ',
            'документ', 'официальный', 'деловой',
            'сми', 'средства массовой информации',
            'образование', 'учеба', 'развитие'
        ],
        'Управление по развитию предпринимательства': [
            'бизнес', 'предприниматель', 'компания',
            'стартап', 'инновация', 'развитие',
            'кредит', 'заем', 'финансирование',
            'налог', 'сбор', 'пошлина',
            'лицензия', 'разрешение', 'документы',
            'рынок', 'конкуренция', 'монополия',
            'экспорт', 'импорт', 'торговля',
            'инвестиция', 'проект', 'план',
            'менеджмент', 'управление', 'организация'
        ],
        'Управление по развитию туризма': [
            'туризм', 'турист', 'путешествие',
            'отель', 'гостиница', 'хостел',
            'экскурсия', 'гид', 'маршрут',
            'достопримечательность', 'памятник', 'музей',
            'отдых', 'развлечение', 'досуг',
            'транспорт', 'перевозка', 'перелет',
            'виза', 'паспорт', 'документы',
            'бронирование', 'заказ', 'оплата',
            'сервис', 'обслуживание', 'качество'
        ],
        'Управление по развитию сельского хозяйства': [
            'сельское хозяйство', 'ферма', 'фермер',
            'земля', 'участок', 'поле',
            'урожай', 'посев', 'сбор',
            'животное', 'скот', 'птица',
            'техника', 'оборудование', 'инвентарь',
            'удобрение', 'пестицид', 'химия',
            'ирригация', 'полив', 'вода',
            'хранение', 'склад', 'переработка',
            'продажа', 'рынок', 'экспорт'
        ],
        'Управление по развитию промышленности': [
            'промышленность', 'завод', 'фабрика',
            'производство', 'продукция', 'товар',
            'технология', 'оборудование', 'станок',
            'сырье', 'материал', 'компонент',
            'энергия', 'электричество', 'топливо',
            'транспорт', 'логистика', 'склад',
            'качество', 'стандарт', 'сертификат',
            'экология', 'безопасность', 'охрана',
            'инновация', 'развитие', 'модернизация'
        ],
        'Управление по развитию торговли': [
            'торговля', 'магазин', 'рынок',
            'товар', 'продукт', 'услуга',
            'цена', 'стоимость', 'скидка',
            'опт', 'розница', 'продажа',
            'импорт', 'экспорт', 'поставка',
            'склад', 'логистика', 'транспорт',
            'качество', 'сертификат', 'стандарт',
            'конкуренция', 'монополия', 'антимонопольный',
            'потребитель', 'клиент', 'покупатель'
        ],
        'Управление по развитию инвестиций': [
            'инвестиция', 'инвестор', 'проект',
            'финансирование', 'кредит', 'заем',
            'развитие', 'строительство', 'модернизация',
            'бизнес', 'компания', 'предприятие',
            'рынок', 'акция', 'облигация',
            'прибыль', 'доход', 'рентабельность',
            'риск', 'страхование', 'гарантия',
            'документ', 'соглашение', 'контракт',
            'налог', 'льгота', 'преференция'
        ],
        'Управление по развитию инноваций': [
            'инновация', 'технология', 'разработка',
            'стартап', 'проект', 'идея',
            'исследование', 'наука', 'лаборатория',
            'патент', 'изобретение', 'открытие',
            'инвестиция', 'финансирование', 'грант',
            'образование', 'обучение', 'развитие',
            'продукт', 'услуга', 'решение',
            'рынок', 'конкуренция', 'монополия',
            'экология', 'устойчивость', 'эффективность'
        ],
        'Управление по развитию цифровизации': [
            'цифровизация', 'информация', 'данные',
            'интернет', 'сайт', 'приложение',
            'программирование', 'разработка', 'код',
            'сервер', 'база данных', 'облако',
            'безопасность', 'защита', 'шифрование',
            'электронный', 'онлайн', 'дистанционный',
            'автоматизация', 'робот', 'искусственный интеллект',
            'сеть', 'коммуникация', 'связь',
            'устройство', 'гаджет', 'техника'
        ],
        'Управление по развитию человеческого капитала': [
            'человеческий капитал', 'образование', 'обучение',
            'навык', 'компетенция', 'квалификация',
            'трудоустройство', 'работа', 'карьера',
            'здоровье', 'медицина', 'спорт',
            'культура', 'творчество', 'искусство',
            'социальная защита', 'поддержка', 'помощь',
            'развитие', 'потенциал', 'талант',
            'инновация', 'креативность', 'предпринимательство',
            'качество жизни', 'благосостояние', 'уровень жизни'
        ]
    }
    
    # Подготовка текста
    text = text.lower()
    words = text.split()
    logger.info(f"Текст после обработки: {text}")
    logger.info(f"Слова в тексте: {words}")
    
    # Подсчитываем количество совпадений для каждого управления
    scores = {}
    max_matches = 0
    
    for department, words_list in keywords.items():
        matches = []
        word_weights = {}  # Словарь для хранения весов слов
        
        for word in words_list:
            if word.lower() in text:
                # Определяем вес слова
                weight = 1.0
                if word in ['школа', 'отопление', 'вода', 'дорога', 'больница']:  # Ключевые слова
                    weight = 2.0
                if len(word.split()) > 1:  # Составные фразы имеют больший вес
                    weight = 2.5
                    
                matches.append(word)
                word_weights[word] = weight
        
        if matches:
            # Считаем общий счет с учетом весов
            total_weight = sum(word_weights[word] for word in matches)
            scores[department] = total_weight
            max_matches = max(max_matches, len(matches))
            logger.info(f"Управление {department}: найдено {len(matches)} совпадений: {matches}, общий вес: {total_weight}")
    
    if not scores:
        logger.info("Не найдено совпадений ни с одним управлением")
        return None, 0.0
    
    # Находим управление с максимальным счетом
    max_department = max(scores.items(), key=lambda x: x[1])
    
    # Рассчитываем уверенность
    # Учитываем количество совпадений и их веса
    base_confidence = (max_department[1] / len(words)) * 100
    
    # Увеличиваем уверенность, если есть несколько совпадений
    if max_matches > 1:
        base_confidence *= 1.5
    
    # Если есть точные совпадения ключевых слов, увеличиваем уверенность
    key_words_matched = any(
        word in text for word in [
            'школа', 'отопление', 'вода', 'дорога', 'больница',
            'детский сад', 'поликлиника', 'жкх', 'транспорт'
        ]
    )
    if key_words_matched:
        base_confidence *= 1.3
    
    # Ограничиваем максимальную уверенность 100%
    confidence = min(base_confidence, 100.0)
    
    logger.info(f"Выбрано управление {max_department[0]} с уверенностью {confidence:.1f}%")
    
    # Получаем управление из базы данных асинхронно
    department = await get_department(max_department[0])
    if department:
        logger.info(f"Управление {max_department[0]} найдено в базе данных")
        return department, confidence
    else:
        logger.error(f"Управление {max_department[0]} не найдено в базе данных")
        return None, 0.0 